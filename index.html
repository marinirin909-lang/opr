<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>e-Pengurusan Pentadbiran - OPR</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');

  :root {
    --primary-color: #800000; 
    --primary-hover: #5a0000;
    --secondary-color: #f9f4f4;
    --border-color: #ccc;
    --text-color: #333;
    --shadow-color: rgba(0,0,0,0.1);
  }

  body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--secondary-color);
    margin: 0;
    padding: 20px;
    color: var(--text-color);
  }

  .main-container {
      display: flex;
      flex-direction: column;
      gap: 30px;
      max-width: 1200px;
      margin: 0 auto;
  }
  
  @media (min-width: 900px) {
      .main-container {
          flex-direction: row;
          align-items: flex-start;
      }
      .input-section {
          flex: 1;
          max-width: 400px;
      }
      .preview-section {
          flex: 2;
      }
  }

  /* Input Section Styles */
  .input-section {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px var(--shadow-color);
      max-height: 90vh;
      overflow-y: auto;
  }

  .input-group { margin-bottom: 15px; }
  .input-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9em; }
  .input-group input, .input-group select, .input-group textarea {
      width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; 
      font-family: 'Poppins', sans-serif; box-sizing: border-box;
  }

  .list-container .list-item { display: flex; align-items: center; margin-bottom: 5px; }
  .list-container input { flex-grow: 1; }
  .btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-left: 5px; }
  .btn-add { background-color: #28a745; color: white; }
  .btn-remove { background-color: #dc3545; color: white; }
  .btn-action { background-color: var(--primary-color); color: white; padding: 10px 20px; width: 100%; font-size: 1em; margin-top: 20px; }
  .btn-secondary { background-color: #555; color: white; padding: 10px 20px; width: 100%; font-size: 1em; margin-top: 10px; }

  /* Image Upload Styles */
  .image-uploader { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .image-input { 
      border: 1px dashed #ccc; padding: 5px; text-align: center; cursor: pointer; height: 60px; display: flex; align-items: center; justify-content: center; overflow: hidden;
  }
  .image-input img { max-width: 100%; max-height: 100%; display: none; }
  .image-input span { font-size: 0.7em; color: #999; }

  /* Preview Section Styles */
  .preview-section {
      background: #ccc;
      padding: 20px;
      border-radius: 12px;
      overflow-x: auto;
      display: flex;
      justify-content: center;
  }

  #opr-report {
      width: 210mm;
      min-height: 297mm;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      padding: 0;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
  }

  /* Default Template Base Styles (Reset for Preview) */
  #opr-report * { box-sizing: border-box; }
  
  /* Helper classes for templates */
  .hidden { display: none; }

</style>
</head>
<body>

<div class="main-container">
  <!-- INPUT FORM SECTION -->
  <div class="input-section">
    <h2>Maklumat Laporan</h2>
    
    <div class="input-group">
        <label>Pilih Template</label>
        <select id="template-select" onchange="updateData()">
            <!-- Options will be populated by JS -->
        </select>
    </div>

    <div class="input-group">
        <label>Unit</label>
        <select id="unit-select" onchange="updateData()">
            <option value="Pentadbiran">Pentadbiran</option>
            <option value="Kurikulum">Kurikulum</option>
            <option value="Hal Ehwal Murid">Hal Ehwal Murid</option>
            <option value="Kokurikulum">Kokurikulum</option>
        </select>
    </div>
    <div class="input-group">
        <label>Tahun</label>
        <select id="year-select" onchange="updateData()">
            <option value="2026" selected>2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
        </select>
    </div>

    <div class="input-group">
        <label>Nama Program / Aktiviti</label>
        <input type="text" id="nama-program" placeholder="Nama Program" oninput="updateData()">
    </div>
    
    <div class="input-group">
        <label>Anjuran</label>
        <select id="anjuran" onchange="updateData()">
              <option>Unit Pentadbiran</option>
              <option>Unit Kurikulum</option> 
              <option>Unit Hem</option>
              <option>Unit Kokurikulum</option>
              <option>Sekolah</option>
              <option value="custom">Lain-lain (Taip sendiri)</option>
        </select>
        <input type="text" id="anjuran-custom" style="display:none; margin-top:5px;" placeholder="Nyatakan Anjuran" oninput="updateData()">
    </div>

    <div class="input-group">
        <label>Tarikh</label>
        <input type="date" id="tarikh" onchange="updateData()">
    </div>

    <div class="input-group">
        <label>Masa</label>
        <input type="time" id="masa" onchange="updateData()">
    </div>

    <div class="input-group">
        <label>Tempat</label>
        <input type="text" id="tempat" placeholder="Lokasi Program" oninput="updateData()">
    </div>

    <div class="input-group">
        <label>Bilangan Peserta / Sasaran</label>
        <input type="text" id="peserta" placeholder="Contoh: Semua Warga TMIS" oninput="updateData()">
    </div>

    <div class="input-group">
        <label>Objektif Program</label>
        <textarea id="objektif" rows="3" placeholder="Nyatakan objektif program..." oninput="updateData()"></textarea>
    </div>

    <div class="input-group">
        <label>Ringkasan Aktiviti</label>
        <textarea id="aktiviti" rows="3" placeholder="Nyatakan aktiviti yang dijalankan..." oninput="updateData()"></textarea>
    </div>

    <div class="input-group">
        <label>Pencapaian / Refleksi (Senarai)</label>
        <div id="objektif-list" class="list-container">
            <div class="list-item"><input type="text" placeholder="Item 1" oninput="updateData()"><button class="btn btn-add" onclick="addListItem('objektif-list')">+</button></div>
        </div>
    </div>

    <div class="input-group">
        <label>Ulasan / Penambahbaikan (Senarai)</label>
        <div id="impak-list" class="list-container">
            <div class="list-item"><input type="text" placeholder="Item 1" oninput="updateData()"><button class="btn btn-add" onclick="addListItem('impak-list')">+</button></div>
        </div>
    </div>

    <div class="input-group">
        <label>Disediakan Oleh</label>
        <select id="nama-guru" onchange="updateData()">
            <option value="">-- Pilih Nama Guru --</option>
            <option value="WAN ROSHANI BINTI WAN MOHAMAD">WAN ROSHANI BINTI WAN MOHAMAD</option>
            <option value="custom">Lain-lain (Taip sendiri)</option>
        </select>
        <input type="text" id="nama-guru-custom" style="display:none; margin-top:5px;" placeholder="Nama Guru" oninput="updateData()">
        <input type="text" id="jawatan-guru" style="margin-top:5px;" placeholder="Jawatan (Cth: Setiausaha)" oninput="updateData()">
    </div>

    <div class="input-group">
        <label>Gambar (Max 6)</label>
        <div class="image-uploader" id="image-uploader">
            <!-- 6 Image slots -->
             <div class="image-input" onclick="triggerFile(1)"><input type="file" id="file1" hidden accept="image/*" onchange="handleImage(this, 1)"><img id="thumb1"><span id="ph1">Gambar 1</span></div>
             <div class="image-input" onclick="triggerFile(2)"><input type="file" id="file2" hidden accept="image/*" onchange="handleImage(this, 2)"><img id="thumb2"><span id="ph2">Gambar 2</span></div>
             <div class="image-input" onclick="triggerFile(3)"><input type="file" id="file3" hidden accept="image/*" onchange="handleImage(this, 3)"><img id="thumb3"><span id="ph3">Gambar 3</span></div>
             <div class="image-input" onclick="triggerFile(4)"><input type="file" id="file4" hidden accept="image/*" onchange="handleImage(this, 4)"><img id="thumb4"><span id="ph4">Gambar 4</span></div>
             <div class="image-input" onclick="triggerFile(5)"><input type="file" id="file5" hidden accept="image/*" onchange="handleImage(this, 5)"><img id="thumb5"><span id="ph5">Gambar 5</span></div>
             <div class="image-input" onclick="triggerFile(6)"><input type="file" id="file6" hidden accept="image/*" onchange="handleImage(this, 6)"><img id="thumb6"><span id="ph6">Gambar 6</span></div>
        </div>
    </div>

    <button class="btn btn-action" id="generate-pdf-btn" onclick="generatePDF()">Hantar Laporan ke Google Drive</button>
    
    <div style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px;">
        <h3>Tetapan Pangkalan Data</h3>
        <div class="input-group">
            <label>Supabase URL</label>
            <input type="text" id="supabase-url" placeholder="https://xyz.supabase.co">
        </div>
        <div class="input-group">
            <label>Supabase Anon Key</label>
            <input type="password" id="supabase-key" placeholder="public-anon-key">
        </div>
        <button class="btn btn-secondary" onclick="saveToSupabase()">Simpan ke Pangkalan Data</button>
    </div>
  </div>

  <!-- PREVIEW SECTION -->
  <div class="preview-section">
      <div id="opr-report">
          <!-- Template content will be injected here -->
      </div>
  </div>
</div>

<script>
    // State
    const state = {
        template: 1,
        unit: 'Pentadbiran',
        year: '2026',
        program: '',
        anjuran: 'Unit Pentadbiran',
        tarikh: '',
        masa: '',
        tempat: '',
        peserta: '',
        objektif: '',
        aktiviti: '',
        pencapaian: [''],
        ulasan: [''],
        disediakan: '',
        jawatan: '',
        images: [null, null, null, null, null, null] // Base64 data
    };

    // Initialization
    window.onload = function() {
        populateTemplateOptions();
        renderTemplate();
        
        // Handle custom inputs
        document.getElementById('anjuran').addEventListener('change', function() {
             document.getElementById('anjuran-custom').style.display = this.value === 'custom' ? 'block' : 'none';
             updateData();
        });
        document.getElementById('nama-guru').addEventListener('change', function() {
             document.getElementById('nama-guru-custom').style.display = this.value === 'custom' ? 'block' : 'none';
             updateData();
        });
    };

    function populateTemplateOptions() {
        const select = document.getElementById('template-select');
        for (let i = 1; i <= 30; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.text = `Template ${i}`;
            select.appendChild(opt);
        }
    }

    function addListItem(listId) {
        const list = document.getElementById(listId);
        const newItem = document.createElement('div');
        newItem.className = 'list-item';
        newItem.innerHTML = `<input type="text" placeholder="Item" oninput="updateData()">
          <button class="btn btn-remove" onclick="removeListItem(this)">-</button>`;
        list.appendChild(newItem);
        updateData();
    }
    
    function removeListItem(btn) {
        btn.parentElement.remove();
        updateData();
    }

    function triggerFile(idx) { document.getElementById('file' + idx).click(); }
    
    function handleImage(input, idx) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                state.images[idx-1] = e.target.result;
                document.getElementById('thumb' + idx).src = e.target.result;
                document.getElementById('thumb' + idx).style.display = 'block';
                document.getElementById('ph' + idx).style.display = 'none';
                renderTemplate();
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function updateData() {
        state.template = parseInt(document.getElementById('template-select').value);
        state.unit = document.getElementById('unit-select').value;
        state.year = document.getElementById('year-select').value;
        state.program = document.getElementById('nama-program').value;
        
        const anjuranVal = document.getElementById('anjuran').value;
        state.anjuran = anjuranVal === 'custom' ? document.getElementById('anjuran-custom').value : anjuranVal;
        
        state.tarikh = document.getElementById('tarikh').value;
        state.masa = document.getElementById('masa').value;
        state.tempat = document.getElementById('tempat').value;
        state.peserta = document.getElementById('peserta').value;
        
        state.objektif = document.getElementById('objektif').value;
        state.aktiviti = document.getElementById('aktiviti').value;

        // Collect list items
        state.pencapaian = Array.from(document.querySelectorAll('#objektif-list input')).map(i => i.value).filter(v => v);
        state.ulasan = Array.from(document.querySelectorAll('#impak-list input')).map(i => i.value).filter(v => v);
        
        const guruVal = document.getElementById('nama-guru').value;
        state.disediakan = guruVal === 'custom' ? document.getElementById('nama-guru-custom').value : guruVal;
        state.jawatan = document.getElementById('jawatan-guru').value;

        renderTemplate();
    }
    
    function formatDate(dateString) {
        if (!dateString) return '';
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        return new Date(dateString).toLocaleDateString('ms-MY', options);
    }
    
    function getHari(dateString) {
        if (!dateString) return '';
        return new Date(dateString).toLocaleDateString('ms-MY', { weekday: 'long' });
    }

    function renderTemplate() {
        const container = document.getElementById('opr-report');
        const data = state;
        
        // Formatting
        const formattedDate = formatDate(data.tarikh); // e.g., Isnin, 20 Januari 2026
        
        // This is where we will inject different HTML based on template ID
        // For now, I'll put a placeholder or call a function I'll define in the next step
        if (typeof window.renderTemplateHTML === 'function') {
            container.innerHTML = window.renderTemplateHTML(data.template, data);
        } else {
             container.innerHTML = `<div style="padding:20px;"><h3>Template ${data.template} Loading...</h3></div>`;
        }
    }

    // Supabase Integration
    let supabaseClient = null;

    function initSupabase() {
        const url = document.getElementById('supabase-url').value;
        const key = document.getElementById('supabase-key').value;
        if(url && key) {
            try {
                supabaseClient = supabase.createClient(url, key);
            } catch(e) {
                console.error("Supabase init error:", e);
            }
        }
    }

    async function saveToSupabase() {
        initSupabase();
        if(!supabaseClient) {
            alert("Sila masukkan Supabase URL dan Key di bahagian Tetapan.");
            return;
        }

        const saveBtn = document.querySelector('.btn-secondary');
        saveBtn.textContent = 'Sedang Menyimpan...';
        saveBtn.disabled = true;

        try {
            // Remove huge image data to save space if needed, but for now we save everything
            const { data, error } = await supabaseClient
                .from('opr_reports')
                .insert([{ 
                    program_name: state.program,
                    report_date: state.tarikh,
                    report_data: state,
                    created_at: new Date().toISOString()
                }]);
            
            if(error) throw error;
            
            alert("Data berjaya disimpan ke Supabase!");
        } catch (error) {
            alert("Ralat menyimpan data: " + error.message);
        } finally {
            saveBtn.textContent = 'Simpan ke Pangkalan Data';
            saveBtn.disabled = false;
        }
    }

    // PDF Generation (Same as before but targeting the preview div)
    const APPS_SCRIPT_URL = "https://script.google.com/macros/library/d/1jT1ZQLN-W7TrgE5PML76YEYXoVV5w3gEm1mj3BGREFe6RKYPTwqK0XWg/2";

    async function generatePDF() {
        const generateBtn = document.getElementById('generate-pdf-btn');
        generateBtn.textContent = 'Sedang Memproses...'; 
        generateBtn.disabled = true;

        try {
            const element = document.getElementById('opr-report');
            // Use html2canvas
            const canvas = await html2canvas(element, { scale: 2, useCORS: true });
            const imgData = canvas.toDataURL('image/png');

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgWidth = 210;
            const pageHeight = 297;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

            const pdfBase64 = pdf.output('datauristring').split(',')[1];
            const fileName = ((state.program || "Laporan_OPR").replace(/[^a-zA-Z0-9]/g, '_')) + ".pdf";

            pdf.save(fileName);

            // Send to Google Drive
            /* Commented out to avoid actual network calls during dev, or we can keep it. 
               The user wants to use it so I should keep it. */
             
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    filename: fileName,
                    base64: pdfBase64,
                    mimeType: "application/pdf"
                })
            }).then(() => {
                 alert("PDF telah dimuat turun ke komputer anda dan dihantar ke Google Drive!");
                 generateBtn.textContent = 'Hantar Laporan ke Google Drive';
                 generateBtn.disabled = false;
            }).catch(e => {
                 console.error(e);
                 // Even if fetch fails (CORS), we assume it might have worked in no-cors or just alert success for user experience if they expect it
                 // But better to alert error if real error
                 alert("PDF dimuat turun. Status hantar ke Drive tidak diketahui (CORS).");
                 generateBtn.textContent = 'Hantar Laporan ke Google Drive';
                 generateBtn.disabled = false;
            });

        } catch (error) {
            alert("Ralat: " + error.message);
            generateBtn.textContent = 'Hantar Laporan ke Google Drive';
            generateBtn.disabled = false;
        }
    }
</script>
<!-- I will append the template rendering logic in a separate file or script block in next steps -->
<script src="templates.js"></script>
</body>
</html>